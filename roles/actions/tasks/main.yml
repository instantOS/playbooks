---
- name: Ensure github actions runner is set up
  community.docker.docker_compose_v2:
    project_name: actions
    definition:
      version: "2.3"
      services:
        worker:
          image: myoung34/github-runner:latest
          environment:
            RUNNER_NAME: instantself
            RUNNER_WORKDIR: /tmp/runner/work
            CONFIGURED_ACTIONS_RUNNER_FILES_DIR: /runner/data # Required for persistence
            RUNNER_SCOPE: "org"
            ORG_NAME: "instantOS"
            APP_LOGIN: "instantOS"
            APP_ID: 2201063
            APP_PRIVATE_KEY: "{{ runner_key }}"
            LABELS: linux,x64
          security_opt:
            # needed on SELinux systems to allow docker container to manage other docker containers
            - label:disable
          volumes:
            - "/var/run/docker.sock:/var/run/docker.sock"
            - "/runner/data:/runner/data" # required for persistence
            - "/tmp/runner:/tmp/runner"
            # note: a quirk of docker-in-docker is that this path
            # needs to be the same path on host and inside the container,
            # docker mgmt cmds run outside of docker but expect the paths from within
